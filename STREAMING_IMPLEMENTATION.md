# Streaming AI Implementation

## Overview

This document describes the implementation of true streaming AI content generation, where document blocks appear in the editor in real-time as they're generated by the AI, rather than waiting for the complete response.

## What Was Changed

### 1. Backend (API Route) - `app/api/ai/command/route.ts`

**Change:** Updated the AI system prompt to request NDJSON (Newline-Delimited JSON) output format.

**Before:**
- AI generated a single JSON object with `explanation`, `changes`, and `modifiedDocument`
- Frontend had to wait for complete response before showing anything

**After:**
- AI streams document blocks incrementally, one per line:
  ```json
  {"type":"block","index":0,"node":{"type":"h1","children":[{"text":"LAST WILL AND TESTAMENT"}]}}
  {"type":"block","index":1,"node":{"type":"p","children":[{"text":"I, [TESTATOR]..."}]}}
  {"type":"complete","explanation":"...","changes":[...],"totalBlocks":2}
  ```
- Each block is a complete, valid JSON object
- Final line contains metadata (explanation and changes summary)

### 2. Frontend Parser - `components/plate-ui/ai-chat.tsx`

**Added:** `parseNDJSON()` async generator function
- Parses streaming response line-by-line
- Yields complete JSON objects as they arrive
- Handles incomplete lines gracefully in buffer

**Updated:** `handleAgentMode()` streaming loop
- Replaced buffer → parse → apply pattern with incremental NDJSON parsing
- Applies blocks to editor as they arrive (with `isStreaming: true` flag)
- Shows animated streaming marks on new content
- Preserves all existing safety checks (content loss detection, destructive change confirmation)

### 3. Editor Integration - `app/(dashboard)/dashboard/wills/[id]/will-editor.tsx`

**Updated:** `AgentEditOptions` interface
- Added `isStreaming?: boolean` flag to distinguish streaming vs. pending states

**Updated:** `applyAIMarks()` function
- Now accepts `isStreaming` parameter
- Applies `streaming: true` mark to text nodes when content is actively being generated

**Updated:** `handleAgentEdit()` function
- Accepts and passes through `isStreaming` flag
- Only resets streaming state when `isStreaming` is false
- Shows toast notification only when changes are finalized (not streaming)

### 4. Visual Feedback - `components/plate-ui/ai-leaf.tsx`

**Added:** `StreamingAILeaf` component
- Shows animated gradient background while content streams in
- Uses emerald color scheme to distinguish from pending (yellow) and confirmed (purple)
- Leverages existing `animate-shimmer` CSS animation from `globals.css`

**Updated:** `AILeaf` component
- Checks for `streaming` mark first, renders `StreamingAILeaf`
- Falls back to `PendingAILeaf` if `pending` mark is present
- Finally shows confirmed purple highlight for finalized AI content

## User Experience Flow

1. **User submits command** in Agent mode (e.g., "Add 3 clauses about charitable giving")

2. **Streaming starts:**
   - Each block appears in the editor as it's generated
   - Content has animated emerald gradient (streaming state)
   - User sees document being "written" in real-time

3. **Streaming completes:**
   - Animation stops, content shows yellow highlight (pending state)
   - Accept/Reject buttons appear in chat panel
   - Content loss detection validates block count

4. **User accepts changes:**
   - Yellow highlights become purple (confirmed state)
   - Changes are saved to database
   - Document is finalized

5. **User rejects changes:**
   - Editor reverts to snapshot taken before streaming started
   - All changes are discarded

## Visual States

| State | Color | Border | Animation | Meaning |
|-------|-------|--------|-----------|---------|
| **Streaming** | Emerald gradient | Solid emerald | Shimmer | Content being generated |
| **Pending** | Yellow | Dashed yellow | None | Awaiting user acceptance |
| **Confirmed** | Purple | Solid purple | None | Changes accepted |

## Safety Features Preserved

✅ **Content Loss Detection:** Still validates that modified document has at least 50% of original blocks
✅ **Destructive Change Confirmation:** Prompts user before deleting substantial content
✅ **Snapshot/Restore:** Takes snapshot before streaming, can revert on error or rejection
✅ **NDJSON Error Handling:** Gracefully handles malformed lines, continues parsing
✅ **Accept/Reject Workflow:** User must explicitly accept changes before they're saved

## Technical Benefits

1. **True Streaming:** Blocks appear as generated, not buffered then displayed
2. **Progressive Feedback:** Users see progress immediately, no blind waiting
3. **Safe Parsing:** Each line is complete JSON, no fragile partial parsing
4. **Industry Standard:** NDJSON is used by OpenAI, Anthropic, and other AI APIs
5. **Maintainable:** Clean separation of concerns, easy to debug

## Testing Checklist

- [ ] Blocks appear incrementally during streaming (not all at once)
- [ ] Streaming animation (emerald gradient) is visible during generation
- [ ] Pending state (yellow highlight) appears after streaming completes
- [ ] Accept button removes highlights and saves changes
- [ ] Reject button restores original document
- [ ] Content loss detection triggers warning when appropriate
- [ ] Destructive changes require confirmation
- [ ] Network interruption doesn't crash the app
- [ ] Multiple rapid commands work correctly
- [ ] Large documents (100+ blocks) stream smoothly

## Alternative Approaches Considered

### Option 1: Simulated Streaming (Rejected)
- Parse complete JSON at end
- Animate applying blocks with delays
- **Cons:** Not true streaming, still waits for full response

### Option 2: Change-Based Streaming (Rejected)
- Stream individual `AgentChange` operations
- Apply changes using Plate's transform methods
- **Cons:** Complex state management, harder to validate

### Option 3: NDJSON Streaming (Implemented)
- Stream blocks as complete JSON objects, one per line
- Parse and apply incrementally
- **Pros:** Clean, safe, progressive, maintainable

## Future Enhancements

1. **Optimistic UI:** Start showing blocks even before first chunk arrives
2. **Cancellation:** Allow user to cancel streaming mid-generation
3. **Streaming Explanation:** Show explanation text as it streams (before blocks complete)
4. **Block Highlighting:** Highlight the specific block being generated
5. **Progress Bar:** Show "Block 5 of 12" progress indicator

## Files Modified

1. `app/api/ai/command/route.ts` (lines 14-62)
2. `components/plate-ui/ai-chat.tsx` (lines 44-660)
3. `app/(dashboard)/dashboard/wills/[id]/will-editor.tsx` (lines 274-345)
4. `components/plate-ui/ai-leaf.tsx` (entire file)
5. `app/globals.css` (no changes needed - animation already exists)

## Related Documentation

- [Plan Document](/Users/aboubakaryaheda/.claude/projects/-Users-aboubakaryaheda-Development-Personal-will-builder/0124316b-dc69-48f7-9982-9f55a9f82456.jsonl) - Original implementation plan
- [NDJSON Spec](http://ndjson.org/) - Newline-Delimited JSON format
- [Plate Editor Docs](https://platejs.org/) - Rich text editor framework
